<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<link href="assets/libs/layui/css/layui.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="assets/css/header.css" type="text/css">
<body>
<div id="header"></div>
<div id="backTree"></div>
<table id="menu"></table>
<script src="assets/libs/jquery/jquery-3.2.1.min.js" type="text/javascript"></script>
<script src="assets/js/axios.min.js" type="text/javascript"></script>
<script src="assets/js/axios.js" type="text/javascript"></script>
<script src="assets/libs/layui/layui.js" type="text/javascript"></script>
<script src="assets/js/main.js" type="text/javascript"></script>
<script src="assets/js/header.js" type="text/javascript"></script>
<script type="text/html" id="backTree-toolbar">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="addSub">新增储能站</button>
        <button class="layui-btn layui-btn-sm" lay-event="batchDelete">批量删除</button>
    </div>
</script>
<script type="text/html" id="treeTable-tools">
    <div class="layui-btn-container">
        <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="addChild">新增子级</a>
        <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="delete">删除</a>
    </div>
</script>
<script>

    layui.use(['form', 'dropdown', 'admin', 'setter', 'layer', 'form'], function () {
        var $ = layui.$;
        var layer = layui.layer;
        var table = layui.table;
        var treeTable = layui.treeTable;
        var dropdown = layui.dropdown;
        var admin = layui.admin;
        var form = layui.form;
        var setter = layui.setter;

        const token = admin.getToken().access_token;
        const user = admin.getUser();
        var treeData = [];
        var nodeData = null;

        generateHeader();
        $('#change-sub').hide();
        $('#current-day').html(currentDay);
        updateTime();
        dropdown.render({
            elem: '#setting',
            data: [
                {title: "定时充放电", id: 1},
                {title: "计划曲线", id: 2},
                {title: "后台管理", id: 3},
            ],
            click: function (obj) {
                if (obj.id === 1) {
                    window.location.href = "/scheduledChDi.html";
                } else if (obj.id === 2) {
                    window.location.href = "/plannedCurve.html";
                } else if (obj.id === 3) {
                    window.location.href = "/backManage.html";
                }
            }
        })

        dropdown.render({
            elem: '#user-action',
            data: [
                {title: '修改密码', id: 99},
                {title: '退出登录', id: 100},
            ],
            click: function (obj) {
                // this.elem.find('span').text(obj.title);
                if (obj.id === 99) {
                    changePswd();
                } else if (obj.id === 100) {
                    logout();
                }
            }
        })


        const addUrl = ['iac/substation/addSub', 'iac/gcPoint/addOne', 'iac/pcs/addOne', 'iac/bms/addOne'];

        var inst = treeTable.render({
            elem: '#menu',
            url: '/getBackTree',
            id: 'backTree',
            headers: {'Authorization': `Bearer ${token}`},
            treeColIndex: 0,	//树形图标显示在第几列
            treeSpid: '0',		//最上级的父级id
            treeIdName: 'id',
            treePidName: 'parentId',
            // treeDefaultClose: false,	//是否默认折叠
            // treeLinkage: true,		//父级展开时是否自动展开所有子级
            toolbar: '#backTree-toolbar',
            cols: [[
                {type: 'checkbox'},
                {field: 'pid', title: 'ID', width: 80, sort: true},
                {field: 'name', title: '名称', width: 200, sort: true},
                {field: 'type', title: '类型', width: 100, sort: true},
                {
                    title: '操作',
                    width: 300,
                    align: 'center',
                    templet: function (d) {
                        if (d.type === 'pcs' || d.type === 'bms') {
                            return '<a class="layui-btn layui-btn-warm layui-btn-xs" style="visibility: hidden" lay-event="userBind">用户关联</a> ' +
                                '<a class="layui-btn layui-btn-warm layui-btn-xs" style="visibility: hidden" lay-event="addChild">新增子级</a>' +
                                '<a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="delete">删除</a>';
                        } else if (d.type === '储能站') {
                            return '<a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="userBind">用户关联</a>' +
                                '<a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="addChild">新增子级</a>' +
                                '<a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="delete">删除</a>';
                        } else {
                            return '<a class="layui-btn layui-btn-warm layui-btn-xs" style="visibility: hidden" lay-event="userBind">用户关联</a>' +
                                '<a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="addChild">新增子级</a>' +
                                '<a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="delete">删除</a>';
                        }
                    }
                }
            ]],
            page: false,
            done: function (response) {
                treeTable.expandAll('backTree', true);
            }
        })


        treeTable.on("toolbar(backTree)", function (obj) {
            if (obj.event === 'addSub') {
                add(null, '根节点');
            }
            if (obj.event === 'batchDelete') {
                var checkStatus = table.checkStatus(obj.config.id);
                console.log(checkStatus);
                console.log(checkStatus.data);
                // for (let i = 0; i < checkStatus.data.length-1; i++) {
                //     del(checkStatus.data[i].id, checkStatus.data[i].type)
                // }
            }
        })

        treeTable.on('tool(' + inst.config.id + ')', function (obj) {
            var layEvent = obj.event;
            var trElem = obj.tr;
            var trData = obj.data;
            var tableId = obj.config.id;
            if (layEvent === 'addChild') {
                add(trData.pid, trData.type);
            } else if (layEvent === 'delete') {
                del(trData.pid, trData.type);
            } else if (layEvent === 'userBind') {
                userBindSub(trData.pid);
            }
        })

        var selectData = [];
        function userBindSub(substationId) {
            var userData;
            admin.req("iac/user/selectAll", function (response) {
                console.log(response);
                userData = response.data;

                userData.forEach(function (user) {
                    selectData.push({value: user.id, name: user.username});
                })

                layer.open({
                    type: 1,
                    title: "用户关联",
                    area: ['600px', '400px'],
                    content: `
                <div class="layui-form">
                <div class="layui-form-item">
                <div class="layui-inline">
                <div class="layui-input-block">
                  <div id="select-users"></div>
                  <button class="layui-btn icon-btn" id="bind-submit"
                     lay-filter="bindSubmit" lay-submit>确定
                  </button>
                  </div>
                  </div>
                  </div>
                </div>
            `,
                    success: function () {
                        admin.select({
                            el: '#select-users',
                            multiple: true,
                            ratio: false,
                            name: 'users',
                            style: {width: '250px'},
                            data: selectData
                        })
                    }
                });
            });



            form.on('submit(bindSubmit)', function (data) {
                var data = data.field;
                console.log(data)
                console.log(data.users)

                admin.req("iac/substaionId/relUser", {substationId: substationId, userIds: data.users.split(',').map(item => +item)}, function (response) {
                    console.log(response)
                })
            })


        }


        function add(id, type) {
            if (type === '并网点') {
                layer.open({
                    type: 1, // 使用layer的页面层
                    title: '添加节点',
                    area: ['400px', '300px'], // 弹窗的宽度和高度
                    content: `
                <div style="padding: 20px;">
                    <form id="addNodeForm">
                        <div class="layui-form-item">
                            <label class="layui-form-label">节点类型：‌</label>
                            <div class="layui-input-block">
                                <select name="nodeType" lay-verify="required" id="selectAddType">
                                    <option value="">请选择类型</option>
                                    <option value="2">pcs</option>
                                    <option value="3">bms</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <button class="layui-btn" lay-submit lay-filter="addNode">立即提交</button>
                                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                            </div>
                        </div>
                    </form>
                </div>
            `,
                    btn: [], // 不显示默认的按钮
                    success: function (layero, index) {
                        // 表单提交事件
                        layui.form.on('submit(addNode)', function (data) {
                            var typeSel = $('#selectAddType[name=nodeType]').val(); // 获取输入框的值
                            console.log(typeSel)
                            if (typeSel === '2' || typeSel === '3') {
                                console.log("post")
                                axios.post(addUrl[typeSel], null, {
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    },
                                    params: {
                                        pointId: id
                                    }
                                })
                                    .then(function () {
                                        layer.close(1, function () {
                                            treeTable.reload('backTree', {data: treeTable});
                                            treeTable.expandAll('backTree', true);
                                        })
                                    })
                            }
                            return false; // 阻止表单跳转
                        });
                    }
                });
            } else if (type === '储能站') {
                console.log("新增并网点")
                axios.post(addUrl[1], null, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    params: {
                        subId: id
                    }
                }).then(function () {
                    treeTable.reload('backTree');
                    treeTable.expandAll('backTree', true);
                })
            } else if (type === '根节点') {
                console.log("新增储能站")
                axios.post(addUrl[0], null, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                }).then(function () {
                    treeTable.reload('backTree');
                    treeTable.expandAll('backTree', true);
                })
            }
            // treeTable.reload('backTree')
        }


        function del(id, type) {
            console.log("delete");
            var url = null;
            if (type === "储能站") {
                url = 'iac/substation/deleteById';
            } else if (type === "并网点") {
                url = 'iac/gcPoint/deleteById';
            } else if (type === 'pcs') {
                url = 'iac/pcs/deleteById';
            } else if (type === 'bms') {
                url = 'iac/bms/deleteById';
            } else {
            }

            layer.confirm('确定删除?', {
                btn: ['确定', '取消']
            }, function (i) {
                axios.delete(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    params: {
                        id: id,
                    }
                })
                    .then(function (response) {
                        console.log("删除")
                    })
                layer.close(i);
                treeTable.reload('backTree');
                treeTable.expandAll('backTree', true);
            }, function () {
                treeTable.expandAll('backTree', true);
            })

        }


    })


</script>
</body>
<style>
    body {
        background-color: #f2f8ff;
    }

    .page-button {
        background-color: #e2e2e2;
        margin: 0 10px;
    }

    #select-users {
        margin-left: 50px;
    }

    #bind-submit {
        margin-left: 80%;
        margin-top: 200px;
    }

    /*.layui-table-body .layui-table, .layui-table-header .layui-table {*/
    /*    margin-left: 100px;*/
    /*}*/

</style>
</html>